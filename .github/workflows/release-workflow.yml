name: Release Workflow

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬ (ä¾‹å¦‚: 1.0.0)'
        required: true
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: true

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Git credentials
        run: |
          git config --global user.email "chengtx007@126.com"
          git config --global user.name "chengtx809"
          git config --global credential.helper store
          echo "https://${{ secrets.GITHUB_TOKEN }}:x-oauth-basic@github.com" > ~/.git-credentials

      - name: Create release branch
        run: |
          git checkout -b release/v${{ github.event.inputs.version }}

      - name: Update version in package.json
        run: |
          # ä½¿ç”¨jqæ›´æ–°package.jsonä¸­çš„ç‰ˆæœ¬å·
          jq '.version = "${{ github.event.inputs.version }}"' package.json > package.json.tmp
          mv package.json.tmp package.json

      - name: Commit changes
        run: |
          git add package.json
          git commit -m "chore: å‘å¸ƒ v${{ github.event.inputs.version }}"

      - name: Push release branch
        run: |
          git push origin release/v${{ github.event.inputs.version }}

      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: å‘å¸ƒ v${{ github.event.inputs.version }}"
          branch: release/v${{ github.event.inputs.version }}
          title: "ğŸš€ å‘å¸ƒ v${{ github.event.inputs.version }}"
          body: |
            ## ç‰ˆæœ¬ v${{ github.event.inputs.version }}

            ${{ github.event.inputs.release_notes }}

            æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºã€‚åˆå¹¶åˆ°ä¸»åˆ†æ”¯åï¼Œå°†ä¼šè‡ªåŠ¨è§¦å‘Dockeré•œåƒæ„å»ºå’Œå‘å¸ƒã€‚
          labels: release
          base: main
